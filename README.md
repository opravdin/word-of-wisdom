# Word of Wisdom

[![Go CI](https://github.com/opravdin/word-of-wisdom/actions/workflows/tests.yml/badge.svg)](https://github.com/opravdin/word-of-wisdom/actions/workflows/tests.yml)

TCP сервер и клиент, предоставляющий цитаты мудрости после успешного выполнения Proof of Work (PoW) задачи, защищая сервер от DDoS-атак.

## Быстрый старт

```bash
# Запуск всех сервисов одной командой
make run

# Или по-простому
docker-compose up -d
```

Веб-интерфейс будет доступен по адресу: **http://localhost:8088**

## Описание проекта
В проекте есть 2 Go приложения: клиент и сервер.  
Сервер реализует условия их задачи: по TCP отдает цитаты, требуя proof of work для каждого входящего запроса.  
Клиент в свою очередь работу исполняет и получает цитату. Также в клиенте поднимается собственный HTTP сервер чтобы можно было удобно запрашивать 

## Скоуп разработки
Большая часть кода написана нейросетями, основной фокус был сделан на этих аспектах:
1. Реализация PoW с защитой от реальных угроз. Подобрал методику с использованием реального алгоритма, учел рост сложности и основные векторы атаки на PoW (см. ниже)

При разработке учитывались такие технические особенности и возможные ситуации:

1. **Proof of Work**: Требует вычислительных ресурсов от клиентов. Используется алгоритм scrypt с высокой сложностью по ресурсам системы и (пока) защищенный от исполнения на существующих асиках.
2. **Ограничение скорости**: Отслеживает количество запросов по IP-адресу
3. **Адаптивная сложность**: Увеличивает сложность для частых запросов. На каждые 10 входящих запросов в минуту увеличивается сложность (число лидирующих нулей)
4. **Отслеживание задач**: Ограничивает количество нерешенных задач на IP. Если клиент запросил и не решил >10 задач, доступ ограничивается на минуту
5. **Истечение срока задачи**: Задачи истекают после настраиваемого времени
6. **Предотвращение повторного использования решений**: Задачи удаляются из хранилища после успешной валидации, предотвращая атаки повторного воспроизведения (replay attacks)
7. **Система поощрения**: С 5% вероятностью при успешном решении задачи счетчик нерешенных задач уменьшается на 2 вместо 1, что поощряет добросовестных клиентов. Защищает от накопления ошибочных задач если есть проблемы с надежностью сети (кейс, когда клиент потерял задачу и не выполнил, но в целом продолжает запрашивать и делать другие задачи)

Технически в системе остались возможности для эксплуатации сервиса с повышенной нагрузкой:  
1. Время жизни задачи больше чем время остывания сложности. В рамках окна можно сгенерировать 5*10 задач с минимальной сложностью и разом отгрузить. Можно фиксить таймингами.
2. Можно эксплуатировать систему поощрения чтобы получать чуть больше задач низкой сложности  
Но в целом эти механизмы не дают завалить сервер запросами: генерация задач все равно относительно быстрая, а объем работ при "превышении полномочий" все равно не такой критичный для сервера

### Клиент

Клиент имеет два режима работы:

- **Режим CLI**: Интерфейс командной строки для получения одной цитаты
- **Режим HTTP-сервера**: Веб-интерфейс для взаимодействия с сервисом (запускается в Compose по умолчанию)

В режиме HTTP сервера доступен интерфейс с основными операциями:
1. Запросить цитату  
2. Запросить работу и не решить (10 раз в течение 1 минуты = бан на новые задачи от сервера на 1 минуту)  
3. Нагрузочный тест (в цикле запрашиваем цитаты и выполняем работу). Пойдет чтобы посмотреть растущую сложность  

Клиент настроен таким образом, чтобы получать все параметры pow с сервера. Возможно, это не так критично (можно захардкодить параметры алгоритма)

## Алгоритм Proof of Work

Алгоритм PoW основан на scrypt:

1. Сервер отправляет задачу с уникальным ID, случайным начальным значением и уровнем сложности
2. Клиент генерирует случайные nonce и вычисляет: `scrypt(challengeID + seed + nonce, challengeID, N, r, p, keyLen)`
3. Клиент находит nonce, который создает хеш с требуемым количеством ведущих нулей (в зависимости от уровня сложности)
4. Сервер проверяет решение и, если оно верно:
   - Удаляет задачу из хранилища
   - С 5% вероятностью уменьшает счетчик нерешенных задач на 2 вместо 1
   - Отправляет цитату клиенту

Уровень сложности увеличивается с количеством запросов от клиента, обеспечивая адаптивное ограничение скорости.

## Протокол

Протокол основан на обмене JSON-сообщениями через TCP. Каждое сообщение заканчивается символом новой строки (`\n`).

### Формат сообщений

```json
{
  "type": "тип_сообщения",
  "data": {
    // содержимое зависит от типа сообщения
  }
}
```

### Типы сообщений

#### 1. Запрос цитаты (Клиент → Сервер)

```json
{
  "type": "quote_request"
}
```

#### 2. PoW задача (Сервер → Клиент)

```json
{
  "type": "pow_challenge",
  "data": {
    "challenge_id": "уникальный_идентификатор",
    "seed": "случайное_начальное_значение",
    "difficulty_level": 2,
    "scrypt_n": 16384,
    "scrypt_r": 8,
    "scrypt_p": 1,
    "key_len": 32
  }
}
```

#### 3. Решение PoW (Клиент → Сервер)

```json
{
  "type": "pow_solution",
  "data": {
    "challenge_id": "уникальный_идентификатор",
    "nonce": "найденное_решение"
  }
}
```

#### 4. Ответ с цитатой (Сервер → Клиент)

```json
{
  "type": "quote_response",
  "data": {
    "text": "Текст цитаты",
    "author": "Автор цитаты"
  }
}
```

#### 5. Ошибка (Сервер → Клиент)

```json
{
  "type": "error",
  "data": {
    "code": "код_ошибки",
    "message": "описание_ошибки"
  }
}
```

### Коды ошибок

- `invalid_request`: Неверный формат запроса
- `invalid_challenge`: Неверный или устаревший идентификатор задачи
- `invalid_solution`: Неверное решение PoW
- `rate_limit_exceeded`: Превышен лимит запросов
- `internal_error`: Внутренняя ошибка сервера


## Сборка и запуск

### Предварительные требования
- Docker и Docker Compose

### Использование Make

```bash
# Сборка сервера и клиента
make build

# Запуск всех тестов
make test

# Просмотр всех доступных команд
make help
```

### Использование Docker Compose

```bash
# Сборка и запуск сервисов в фоновом режиме
make run

# Пересборка клиента (если были внесены изменения)
docker-compose build client

# Запуск сервисов в интерактивном режиме
docker-compose up

# Остановка сервисов
make stop

# Просмотр логов
make logs
```

После запуска сервисов, веб-интерфейс клиента будет доступен по адресу:
**http://localhost:8088**

### Веб-интерфейс

Клиент предоставляет веб-интерфейс, который позволяет:

1. Получать цитаты мудрости через браузер
2. Просматривать статистику выполнения Proof of Work
3. Отслеживать параметры сложности и время решения задач
4. Запускать нагрузочное тестирование для оценки производительности

Для доступа к веб-интерфейсу при запуске через Docker Compose:
- Откройте в браузере: **http://localhost:8088**

### Конфигурация клиента

Клиент может быть настроен с помощью переменных окружения:

- `SERVER_ADDRESS`: Адрес сервера Word of Wisdom (по умолчанию: "localhost:8080")
- `HTTP_ADDRESS`: Адрес HTTP сервера (по умолчанию: "localhost:3000")
- `CONNECT_TIMEOUT`: Таймаут TCP соединения (по умолчанию: 10s)
- `READ_TIMEOUT`: Таймаут чтения TCP (по умолчанию: 30s)
- `WRITE_TIMEOUT`: Таймаут записи TCP (по умолчанию: 30s)
- `SOLVE_TIMEOUT`: Максимальное время на решение PoW задачи (по умолчанию: 30s)

### Конфигурация сервера

Сервер может быть настроен с помощью переменных окружения:

- `REDIS_HOST`: Хост Redis (по умолчанию: "localhost")
- `REDIS_PORT`: Порт Redis (по умолчанию: "6379")
- `REDIS_PASSWORD`: Пароль Redis
- `REDIS_DB`: Номер базы данных Redis
- `POW_SCRYPT_N`: Параметр N для scrypt (по умолчанию: 16384)
- `POW_SCRYPT_R`: Параметр r для scrypt (по умолчанию: 8)
- `POW_SCRYPT_P`: Параметр p для scrypt (по умолчанию: 1)
- `POW_KEY_LEN`: Длина ключа scrypt (по умолчанию: 32)
